---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# ints

<!-- badges: start -->
<!-- badges: end -->

[`{ints}`](ds-turner.github.io/ints/) helps users tidy up messy ints. It can group and merge overlapping ints as well as remove parts of one set of ints, based on another set of ints. In this context an interval is defined as having a start and a stop.  It can be numeric or date type.

{ints} uses [`{data.table}`](https://rdatatable.gitlab.io/data.table/) for memory efficiency and speed, it will always return a `data.table` object. 

## Installation

You can install the development version of ints from [GitHub](https://github.com/) with:

``` r
pak::pak("ds-turner/ints")
```

## Useage
```{r}
library(ints)
```
### Grouping and Merging Intervals
```{r}
 ints <- data.frame(
    id = c("A", "A", "A", "B", "B", "B"),
    st = c(1, 2, 5, 10, 12, 14),
    end = c(3, 4, 7, 11, 14, 16)
  )
 ints
```

`ints` is a set of overlapping intrevals.   We can identify the overlapping ints and add an ID column `int_grp_id` for overlapping groups.
```{r}
grp_ints(ints, st, end, id)
```
We can also merge the overlapping intervels into single ints.
```{r}
merge_ints(ints, st, end, id)
```
### Triming Intervals
You can remove parts of ints based on another set of ints.
```{r}
pats <- 7

x <- data.frame(
  id = c(1:pats),
  start = rep(5, pats),
  end = rep(20, pats)
)

y <- data.frame(
  id = c(1, 2, 3, 4, 5, 5, 5, 6, 6, 6, 6, 7, 7, 7, 7),
  start = c(10, 4, 4, 19, 4, 10, 19, 4, 9, 14, 19, 7, 9, 11, 13),
  end = c(15, 21, 6, 21, 6, 15, 21, 6, 11, 16, 21, 8, 10, 12, 18)
)
```

Here we will remove the parts of the ints in x that overlap with the ints in y.
```{r}
trm_ints(x, y, start, end, start, end, id)
```

### Negative Intervals
```{r}
ints <- data.frame(
  id = c("a", "a", "a", "a", "a", "b", "b", "c",   "c", "c", "c", "d"),
  start = c(1, 4, 10, 18, 23, 7, 12, 1, 7, 12, 23, 10),
  end = c(3, 7, 15, 21, 25, 9, 16, 3, 9, 16, 25, 15),
  index = c(5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5),
  study_end = c(20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20)
)
ints
```
We can also create a set of ints that represent the gaps between the given ints.
```{r}
neg_ints(ints, start, end, id)
```
These ints can have an upper and lower bounds if required
```{r}
neg_ints(ints, start, end, id, .lower = index, .upper = study_end)
```
###
We have been given the below treatment data.  Each patient has a period monthly treatment for the duration of 2023.  For our analysis we will consider the different dose frequencies as mutually exclusive and higharical, i.e. a patient will not be considered as being dosed weekly if there is a record of daily dosing and a patient will not be considered as being dosed monthly if there is a record of weekly dosing.  
```{r}
trt <- data.frame(
  pat_id = c(1, 1, 1,
             2, 2, 2
             ),
  trt_start_date = as.Date(c(
    "2023-07-13", "2023-06-05", "2023-01-01",
    "2023-03-02", "2023-03-05", "2023-01-01"
  )),
  trt_end_date = as.Date(c(
    "2023-07-20", "2023-08-15", "2023-12-31",
    "2023-03-10", "2023-03-15", "2023-12-31"
  )),
  dose_freq = c(
    "daily", "weekly",  "monthly",
    "daily", "weekly", "monthly"
  )
)

trt
```

Then we can split up the ints to make sure everything is mutually exclusive.
```{r}
# create a list contaiing each dose level
trt_list <- split(trt, trt$dose_freq)

# remove the parts of the week dosing periods that overlap with the daily dosing ints
trt_list$weekly <- trm_ints(
  trt_list$weekly,
  trt_list$daily,
  trt_start_date,
  trt_end_date,
  trt_start_date,
  trt_end_date,
  pat_id,
  .gap = 1
  )
# remove the parts of the monthly dosing periods that overlap with the daily and weekly dosing ints
trt_list$monthly <- trm_ints(
  trt_list$monthly,
  rbind(trt_list$daily, trt_list$weekly),
  trt_start_date,
  trt_end_date,
  trt_start_date,
  trt_end_date,
  pat_id,
  .gap = 1
  )

trt2 <- data.table::rbindlist(
  trt_list
)
data.table::setorder(trt2, pat_id, trt_start_date)

trt2
```

## Keywords
interval packing; interval merging; interval cutting;
